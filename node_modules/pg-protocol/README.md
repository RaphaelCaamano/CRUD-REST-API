# pg-protocol

Low-level PostgreSQL wire protocol parser and serializer written in TypeScript.
Used by node-postgres to handle communication with PostgreSQL servers at the wire protocol level.

## Table of Contents   
- Introduction
- Features
- Installation
- Usage
- Protocol Overview
- Parser
- Serializer
- Supported Messages
- TypeScript Types
- Development
- Contributing
- License
- References
  
## Introduction
pg-protocol provides a low-level implementation of the PostgreSQL wire protocol, enabling parsing and serialization of protocol messages. It is designed to be used as a building block for database clients and tools requiring direct protocol manipulation.

## Features
- Full support for PostgreSQL wire protocol message parsing and serialization.
- Typed interfaces for all message types.
- Efficient, streaming-compatible design.
- Extensible for custom protocol extensions.
- Written entirely in TypeScript with type safety.

## Installation

```js
npm install pg-protocol
```
or
```
yarn add pg-protocol
```

## Usage


Basic example: parsing incoming messages
```js
import { createParser } from 'pg-protocol';

const parser = createParser();

parser.on('message', (msg) => {
  console.log('Received message:', msg);
});

// Simulate receiving raw data buffer from PostgreSQL server
const rawDataBuffer = Buffer.from(/* ... */);
parser.parse(rawDataBuffer);
```

## Serializing messages
```js
import { createSerializer } from 'pg-protocol';

const serializer = createSerializer();

const startupMessage = serializer.startup({ user: 'test', database: 'testdb' });
const queryMessage = serializer.query('SELECT * FROM users');

const buffers = [startupMessage, queryMessage];
for (const buf of buffers) {
  // Send buf over TCP socket
}
```
(Note: Actual usage will involve socket integration and message framing.)

## Protocol Overview
PostgreSQL's wire protocol consists of a sequence of messages exchanged between the client and server. Messages are generally composed of:

- A message type byte (1 byte)
- A Int32 message length (including self)
- Message-specific payload
  
This library handles the parsing and serialization of these messages, supporting the full set of protocol message types.

## Parser
The parser processes incoming byte streams and emits parsed message objects.

#### API
```js
import { createParser, Parser } from 'pg-protocol';

const parser: Parser = createParser();

parser.on('message', (message) => {
  // handle message
});

parser.parse(buffer);
```
#### Events
- 'message': emitted when a complete message is parsed.
  
#### Methods
- .parse(buffer: Buffer): feeds data into the parser.
- .destroy(): cleans up resources.
  
## Serializer
The serializer creates protocol messages from JavaScript objects.

#### API
```js
import { createSerializer, Serializer } from 'pg-protocol';

const serializer: Serializer = createSerializer();

const startupBuffer = serializer.startup({ user: 'user', database: 'db' });
const queryBuffer = serializer.query('SELECT * FROM table');
```
#### Methods
- .startup(params: object): creates a startup message.
- .query(text: string): creates a query message.
- .cancel(), .password(), etc.: other message constructors.
  
## Supported Messages
#### Client to Server
- Startup
- PasswordMessage
- Query
- Parse
- Bind
- Execute
- Sync
- Close
- Describe
- Terminate
- CancelRequest
- Password
#### Server to Client
- Authentication
- BackendKeyData
- ParameterStatus
- ReadyForQuery
- ErrorResponse
- RowDescription
- DataRow
- CommandComplete
- CloseComplete
- NoticeResponse
- NotificationResponse
  
(Refer to PostgreSQL protocol documentation for full message set.)

## TypeScript Types
Type definitions ensure type safety across message processing.

```js
interface Message {
  type: string;
  content: any;
}

interface StartupMessage {
  protocolVersion: number;
  params: { [key: string]: string };
}

// Add more detailed interfaces for each message type
```
## Development

#### Building
```js
git clone https://github.com/yourusername/pg-protocol.git
cd pg-protocol
npm install
npm run build
```
#### Testing
```js
npm test
```

## References
- PostgreSQL Protocol Documentation
- node-postgres Protocol Usage
  
[PostgreSQL-Protocol-Documentation]: https://tools.ietf.org/html/draft-cutler-httpbis-partitioned-cookies/](https://www.postgresql.org/docs/current/protocol.html
[node-postgres-Protocol-Usage]: https://tools.ietf.org/html/draft-west-cookie-priority-00#section-4.1](https://github.com/brianc/node-postgres


## License

[MIT](LICENSE)
